<!--
    This file is part of InfoGrid(tm). You may not use this file except in
    compliance with the InfoGrid license. The InfoGrid license and important
    disclaimers are contained in the file LICENSE.InfoGrid.txt that you should
    have received with InfoGrid. If you have not received LICENSE.InfoGrid.txt
    or you do not consent to all aspects of the license and the disclaimers,
    no license is granted; do not use this file.
 
    For more information about InfoGrid go to http://infogrid.org/

    Copyright 1998-2009 by R-Objects Inc. dba NetMesh Inc., Johannes Ernst
    All rights reserved.
-->

<project name="infogrid-ant-functions" default="none">

  <property name="classpath.moduleadvertisementserializer"
            value="${infogrid.org.modules.fnd}/org.infogrid.module.moduleadvertisementserializer/dist/org.infogrid.module.moduleadvertisementserializer.jar:${infogrid.org.modules.fnd}/org.infogrid.module/dist/org.infogrid.module.jar:${infogrid.org.modules.fnd}/org.infogrid.util/dist/org.infogrid.util.jar"/>
  <property name="class.moduleadvertisementserializer"
            value="org.infogrid.module.moduleadvertisementserializer.ModuleAdvertisementSerializer"/>

  <property name="classpath.bootloader"
            value="${infogrid.org.modules.fnd}/org.infogrid.module/dist/org.infogrid.module.jar:${infogrid.org.modules.fnd}/org.infogrid.module.commandline/dist/org.infogrid.module.commandline.jar"/>
  <property name="class.bootloader"
            value="org.infogrid.module.commandline.CommandlineBootLoader"/>

  <property name="webapp.path" value="/${ant.project.name}" /> <!-- default -->

  <target name="-module-setup"
          depends="-module-setup-analyse,-module-setup-check,-module-setup-ads,-module-setup-models"/>

  <target name="-module-setup-analyse">
    <mkdir dir="${build.dir}/module-generated/infogrid-moduleads"/>
    <condition property="thismodule.generate.ads" value="true">
      <and>
        <available file="infogrid-moduleads/module.adv"/>
        <not>
          <uptodate  srcfile="infogrid-moduleads/module.adv" targetfile="${build.dir}/module-generated.touch"/>
        </not>
      </and>
    </condition>
    <condition property="thismodule.generate.models" value="true">
      <and>
        <available file="infogrid-models/model.xml"/>
        <not>
          <uptodate  srcfile="infogrid-models/model.xml" targetfile="${build.dir}/module-generated.touch"/>
        </not>
      </and>
    </condition>
    <condition property="thismodule.generate.both" value="true">
      <and>
        <istrue value="${thismodule.generate.ads}"/>
        <istrue value="${thismodule.generate.models}"/>
      </and>
    </condition>
    <condition property="available.class.bootloader" value="true">
        <available classname="${class.bootloader}" classpath="${classpath.bootloader}"/>
    </condition>
    <condition property="available.class.moduleadvertisementserializer" value="true">
        <available classname="${class.moduleadvertisementserializer}" classpath="${classpath.moduleadvertisementserializer}"/>
    </condition>
  </target>
  
  <target name="-module-setup-check" if="thismodule.generate.both">
    <fail message="Both infogrid-moduleads/module.adv and infogrid-models/model.xml given."/>
  </target>
  
  <target name="-module-setup-ads" if="thismodule.generate.ads">
    <!-- if you change this, note that virtually the same code also exists in the -module-setup-models target -->
    <fail unless="available.class.moduleadvertisementserializer"
          message="ModuleAdvertisementSerializer not available. Compile first."/>

    <java fork="true" failonerror="true" classname="${class.moduleadvertisementserializer}">
      <arg value="-xml"/>
      <arg value="infogrid-moduleads/module.adv"/>
      <arg value="${build.dir}/module-generated/infogrid-moduleads"/>
      <classpath path="${classpath.moduleadvertisementserializer}"/>
    </java>
    <java fork="true" failonerror="true" classname="${class.moduleadvertisementserializer}">
      <arg value="-ser"/>
      <arg value="infogrid-moduleads/module.adv"/>
      <arg value="${build.dir}/module-generated/infogrid-moduleads"/>
      <classpath path="${classpath.moduleadvertisementserializer}"/>
    </java>
    <java fork="true" failonerror="true" classname="${class.moduleadvertisementserializer}">
      <arg value="-java"/>
      <arg value="infogrid-moduleads/module.adv"/>
      <arg value="${build.dir}/module-generated"/>
      <classpath path="${classpath.moduleadvertisementserializer}"/>
    </java>
    <copy todir="${dist.dir}">
      <fileset dir="${build.dir}/module-generated/infogrid-moduleads">
        <include name="*.adv"/>
        <include name="*.ser"/>
      </fileset>
    </copy>
    <xslt in="infogrid-moduleads/module.adv"
          out="${build.dir}/module-description.html"
          style="${infogrid.org.tools}/module-to-module-description.xsl">
      <xmlcatalog>
        <dtd publicId="-//InfoGrid.org//InfoGrid Model//EN"
             location="${infogrid.org.modules.fnd}/org.infogrid.module/src/org/infogrid/module/module.dtd"/>
      </xmlcatalog>
    </xslt>
    <touch file="${build.dir}/module-generated.touch"/>
  </target>
    
  <target name="-module-setup-models" if="thismodule.generate.models">
    <!-- if you change this, note that virtually the same code also exists in the -module-setup-ads target -->
    <fail unless="available.class.moduleadvertisementserializer"
          message="ModuleAdvertisementSerializer not available. Compile first."/>
    <fail unless="available.class.bootloader"
          message="Module frameworks' BootLoader not available. Compile first."/>

    <mkdir dir="${build.dir}/module-generated/infogrid-models"/>
    <mkdir dir="${build.dir}/module-generated/infogrid-moduleads"/>

    <copy file="infogrid-models/model.xml" tofile="${build.dir}/module-generated/infogrid-models/${ant.project.name}.V.xml"/>

    <xslt in="infogrid-models/model.xml"
          out="${build.dir}/module-from-model.adv"
          style="${infogrid.org.tools}/model-to-adv.xsl">
      <xmlcatalog>
        <dtd publicId="-//InfoGrid.org//InfoGrid Model//EN"
             location="${infogrid.org.modules.fnd}/org.infogrid.kernel/src/org/infogrid/modelbase/externalized/xml/model.dtd"/>
      </xmlcatalog>
    </xslt>
    <xslt in="infogrid-models/model.xml"
          out="${build.dir}/module-description.html"
          style="${infogrid.org.tools}/model-to-module-description.xsl">
      <xmlcatalog>
        <dtd publicId="-//InfoGrid.org//InfoGrid Model//EN"
             location="${infogrid.org.modules.fnd}/org.infogrid.kernel/src/org/infogrid/modelbase/externalized/xml/model.dtd"/>
      </xmlcatalog>
    </xslt>

    <java fork="true" failonerror="true" classname="${class.moduleadvertisementserializer}">
      <arg value="-xml"/>
      <arg value="${build.dir}/module-from-model.adv"/>
      <arg value="${build.dir}/module-generated/infogrid-moduleads"/>
      <classpath path="${classpath.moduleadvertisementserializer}"/>
    </java>
    <java fork="true" failonerror="true" classname="${class.moduleadvertisementserializer}">
      <arg value="-ser"/>
      <arg value="${build.dir}/module-from-model.adv"/>
      <arg value="${build.dir}/module-generated/infogrid-moduleads"/>
      <classpath path="${classpath.moduleadvertisementserializer}"/>
    </java>
    <java fork="true" failonerror="true" classname="${class.moduleadvertisementserializer}">
      <arg value="-java"/>
      <arg value="${build.dir}/module-from-model.adv"/>
      <arg value="${build.dir}/module-generated"/>
      <classpath path="${classpath.moduleadvertisementserializer}"/>
    </java>

    <copy todir="${dist.dir}">
      <fileset dir="${build.dir}/module-generated/infogrid-moduleads">
        <include name="*.adv"/>
        <include name="*.ser"/>
      </fileset>
    </copy>

    <java classname="${class.bootloader}"
          classpath="${classpath.bootloader}"
          failonerror="true" fork="yes">
      <arg value="-rootmodule"/>
      <arg value="org.infogrid.codegen"/>
      <arg value="-installdir"/>
      <arg value="${all.modules.dirs}"/>
      <arg value="${ant.project.name}"/>
      <arg value="-o"/>
      <arg value="../${ant.project.name}/build/module-generated/"/>
    </java>
    <touch file="${build.dir}/module-generated.touch"/>
  </target>

<!-- We override fail-on-error -->
  <target name="-init-macrodef-java">
    <macrodef name="java" uri="http://www.netbeans.org/ns/j2se-project/1">
      <attribute default="${main.class}" name="classname"/>
      <element name="customize" optional="true"/>
      <sequential>
        <java classname="@{classname}" dir="${work.dir}" fork="true" failonerror="true">
          <jvmarg line="${run.jvmargs}"/>
          <classpath>
            <path path="${run.classpath}"/>
          </classpath>
          <syspropertyset>
            <propertyref prefix="run-sys-prop."/>
            <mapper from="run-sys-prop.*" to="*" type="glob"/>
          </syspropertyset>
          <customize/>
        </java>
      </sequential>
    </macrodef>
  </target>

<!-- override javadoc so we don't have to set the additional parameters in each module -->
  <target depends="init" name="-javadoc-build">
    <mkdir dir="${dist.javadoc.dir}"/>
    <javadoc additionalparam="${javadoc.additionalparam} -stylesheetfile ${infogrid.org.tools}/module-stylesheet.css -doctitle &quot;Module ${ant.project.name}&quot; -overview ${basedir}/${build.dir}/module-description.html"
                 author="${javadoc.author}"
                 charset="UTF-8"
                 destdir="${dist.javadoc.dir}"
                 docencoding="UTF-8"
                 encoding="${javadoc.encoding.used}"
                 failonerror="true"
                 noindex="${javadoc.noindex}"
                 nonavbar="${javadoc.nonavbar}"
                 notree="${javadoc.notree}"
                 private="${javadoc.private}"
                 source="${javac.source}"
                 splitindex="${javadoc.splitindex}"
                 use="${javadoc.use}"
                 useexternalfile="true"
                 version="${javadoc.version}"
                 windowtitle="${javadoc.windowtitle}">
      <classpath>
        <path path="${javac.classpath}"/>
      </classpath>
      <fileset dir="${src.dir}" excludes="${excludes}" includes="${includes}">
        <filename name="**/*.java"/>
      </fileset>
      <fileset dir="${src.module-generated.dir}" excludes="${excludes}" includes="${includes}">
        <filename name="**/*.java"/>
      </fileset>
    </javadoc>
  </target>

<!-- override pre-init so it is easy to set up automated builds -->
  <target name="-pre-init" depends="read-build-properties,set-build-properties" />
  <target name="set-build-properties"/>

  <target name="read-build-properties" if="build.properties">
    <available file="${build.properties}" property="build-properties-present"/>
    <fail unless="build-properties-present" message="Build property file ${build.properties} not found."/>
    <property file="${build.properties}"/>
  </target>

<!-- Debian target -->

  <path id="ant-deb.classpath">
    <pathelement location="../../vendors/code.google.com/p/ant-deb-task/ant-deb.jar"/>
  </path>

  <taskdef name="debian-package" classname="com.googlecode.ant_deb_task.Deb" classpathref="ant-deb.classpath"/>

  <target name="debian-package-war" depends="-init-project">
    <mkdir dir="dist"/>
    <mkdir dir="dist/debian"/>
    <tstamp>
      <format property="touch.time" pattern="yyyyMMdd'Z'hhmmss" timezone="UTC"/>
    </tstamp>

    <echo message="Debian dependencies are ${debian.dependencies}"/>
    <fail message="Property debian.dependencies not set.">
      <condition>
        <not>
          <isset property="debian.dependencies"/>
        </not>
      </condition>
    </fail>

    <!-- We know this is a WAR project, so the file will exist. -->
    <copy file="web/META-INF/context.xml" tofile="dist/${ant.project.name}.xml"/>
    <copy file="${infogrid.org.tools.debian}/security.policy" tofile="dist/debian/60${ant.project.name}.policy"/>
    <replace file="dist/debian/60${ant.project.name}.policy" token="@PACKAGE_NAME@" value="${ant.project.name}"/>

    <copy file="${infogrid.org.tools.debian}/postinst" tofile="dist/debian/postinst"/>
    <copy file="${infogrid.org.tools.debian}/prerm"    tofile="dist/debian/prerm"/>
    <copy file="${infogrid.org.tools.debian}/postrm"   tofile="dist/debian/postrm"/>
    <replace file="dist/debian/postinst" token="@PACKAGE_NAME@" value="${ant.project.name}"/>
    <replace file="dist/debian/prerm"    token="@PACKAGE_NAME@" value="${ant.project.name}"/>
    <replace file="dist/debian/postrm"   token="@PACKAGE_NAME@" value="${ant.project.name}"/>

    <debian-package
              package="${ant.project.name}"
              todir="dist"
              section="web"
              postinst="dist/debian/postinst"
              prerm="dist/debian/prerm"
              postrm="dist/debian/postrm"
              depends="${debian.dependencies}">
      <version upstream="2.0.0-${touch.time}"/>
      <maintainer name="InfoGrid Build Master" email="buildmaster@infogrid.org"/>
      <description synopsis="InfoGrid module ${ant.project.name}">
For documentation, please refer to InfoGrid.org.
      </description>
      <tarfileset prefix="var/lib/tomcat5.5/webapps" dir="dist">
        <include name="${ant.project.name}.war"/>
      </tarfileset>
      <!-- We include a number of files that we don't really need to distribute, but
           doing so helps apt-get remove to clean up in all the right places -->
      <tarfileset prefix="var/lib/tomcat5.5/conf/Catalina/localhost" dir="dist">
        <include name="${ant.project.name}.xml"/>
      </tarfileset>
       
      <tarfileset prefix="var/lib/tomcat5.5/conf/Catalina/localhost/${ant.project.name}" dir="../../tools/debian">
        <include name="tldCache.ser"/>
      </tarfileset>
      <tarfileset prefix="etc/tomcat5.5/policy.d" dir="dist/debian">
        <include name="60${ant.project.name}.policy"/>
      </tarfileset>
    </debian-package>
  </target>

  <path id="deployer.classpath">
    <fileset dir="../../vendors/tomcat.apache.org/apache-tomcat-deployer/lib">
      <include name="*.jar"/>
    </fileset>
  </path>
  <taskdef resource="org/apache/catalina/ant/catalina.tasks"
           classpathref="deployer.classpath"/>

  <target name="tomcat-deploy" depends="-pre-init" description="Deploy to Tomcat per current settings">
    <exec executable="pwd" outputproperty="pwd"/> <!-- stupid deploy task does not get the current directory right -->
    <deploy path="${webapp.path}"
            war="${pwd}/dist/${ant.project.name}.war"
            url="${tomcat.manager.url}"
            username="${tomcat.manager.user}"
            password="${tomcat.manager.password}"
            update="true" />
  </target>

  <target name="tomcat-undeploy" depends="-pre-init" description="Undeploy from Tomcat per current settings">
    <exec executable="pwd" outputproperty="pwd"/> <!-- stupid deploy task does not get the current directory right -->
    <undeploy path="${webapp.path}"
            url="${tomcat.manager.url}"
            username="${tomcat.manager.user}"
            password="${tomcat.manager.password}" />
  </target>
</project>
